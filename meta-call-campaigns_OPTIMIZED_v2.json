{
  "id": "meta-call-campaigns",
  "name": "Meta Call Campaigns",
  "description": "Campaign system for outbound call campaigns: lead management, scheduling, retry rules, and live monitoring.",
  "frameworks": [
    "Node.js",
    "TypeScript",
    "Express",
    "PostgreSQL",
    "DB Queueing Pattern",
    "Claim Rows Pattern (Idempotent)",
    "node-cron",
    "BullMQ (scalable)",
    "Redis (for BullMQ)",
    "CSV Parser",
    "Timezone Handling",
    "SSE (Server-Sent Events)",
    "ProviderRegistry",
    "Call Orchestrator Integration"
  ],
  "knowledge": {
    "patterns": [
      "Call Orchestrator Pattern (State Machine: INIT→LISTENING→THINKING→SPEAKING)",
      "Telephony Adapter Pattern (Vendor-agnostic, no KI-Logic)",
      "Claim Rows Pattern (Idempotent)",
      "Fake Adapter Pattern (Testability)"
    ],
    "bestPractices": [
      "Hard permission boundaries (admin",
      "only campaign management).",
      "Full audit logging.",
      "Idempotent job execution (no duplicate calls).",
      "No \"auto install\" of anything external; only implement within this app.",
      "Hard permission boundaries (admin-only)",
      "Locale Storage: Global Default + Per Team + Per Agent (de-DE, en-US, it-IT, fr-FR, pl-PL)",
      "Auto-Detect Toggle: Detect in first 1-2 turns, then lock locale",
      "STT Language Mode: auto or fixed locale (de, en, it, fr, pl)",
      "TTS Voice Mapping: DE→Voice_DE, EN→Voice_EN, IT→Voice_IT, FR→Voice_FR, PL→Voice_PL",
      "Voice Reply Policy: Max 2 sentences per turn, max 8-12s speech, ask-one-question rule",
      "Prompt Rule: Always respond in user language + \"Wenn unsicher, stelle kurze Rückfrage\"",
      "Multilingual Tuning: Use short spoken phrasing common in targetLanguage",
      "Multilingual Tuning: Avoid literal translations; choose natural phone phrasing",
      "Multilingual Tuning: Always confirm understanding with ONE short paraphrase after complex message",
      "Multilingual Tuning: Use polite form by default (DE: Sie; FR: vous; IT: Lei; PL: Pan/Pani) unless caller uses informal",
      "Multilingual Tuning: Keep numbers/dates slow and clear (group digits)",
      "Multilingual Templates: Greeting/Consent/Compliance per language",
      "Do not translate: Product names, company names, prices, URLs, CRM status codes",
      "Quality Scorecard: Language correctness, response length, clarification questions",
      "Language suggestion by phone prefix: +49→de-DE, +39→it-IT, +33→fr-FR, +48→pl-PL",
      "Mixed-language handling: Agent can switch but must confirm logically",
      "Minimal Defaults: Auto-detect ON, lock after 1st detection, 2 sentences max, ~10s speech",
      "Provider: OpenRouter Tier A/B default, Premium fallback on failures"
    ],
    "commonIssues": [
      "Campaign stuck (no progress)"
    ],
    "toolRecommendations": [
      "Twilio Voice SDK + REST API"
    ]
  },
  "systemInstructions": "TASK: CALL CAMPAIGNS — Lead Lists + Scheduling + Retry Rules + Live Monitoring\n\nPREREQ:\nAssume CALL MVP exists (Orchestrator + Twilio adapter). Do NOT change its core behavior unless required.\n\nGOAL:\nAdd a campaign system that can run outbound call campaigns autonomously:\n- import leads\n- schedule windows\n- call attempts + retry policy\n- dispositions/outcomes\n- live monitoring + reports\n- admin controls\n\nNON-NEGOTIABLE:\n- Hard permission boundaries (admin-only campaign management).\n- Full audit logging.\n- Idempotent job execution (no duplicate calls).\n- No \"auto install\" of anything external; only implement within this app.\n\nFEATURES:\n\nA) Data Model (DB):\n- campaigns: id, name, status(draft/running/paused/completed), timezone, callingWindows, maxAttempts, retryDelays, concurrency, createdBy\n- leads: id, campaignId, phone, name, attributesJson, status(new/queued/called/success/fail/dnc), lastCallAt, attemptCount, nextAttemptAt\n- call_attempts: id, campaignId, leadId, callSessionId, startedAt, endedAt, outcome, errorCategory, recordingUrl(optional), transcriptRef(optional)\n\nB) Lead Import/Export:\n- Upload CSV (admin UI) -> create leads\n- Download template CSV\n- Export results CSV\n\nC) Scheduler + Queue:\n- Job that picks eligible leads:\n  - within calling window (timezone aware)\n  - nextAttemptAt <= now\n  - attemptCount < maxAttempts\n  - not DNC\n- Concurrency control:\n  - max N active calls per campaign\n  - global limit\n- Use single-instance-safe pattern (DB locks or \"claim rows\" strategy).\n\nD) Call Execution:\n- For each claimed lead:\n  - call Orchestrator startOutboundCall with campaignId + leadId metadata\n  - on completion: store outcome + update lead status + schedule nextAttemptAt if retryable\n\nE) Dispositions / Rules:\n- Map outcomes:\n  - SALE -> lead.success\n  - CALLBACK -> schedule nextAttemptAt\n  - NO_ANSWER/BUSY -> retry with backoff\n  - DNC -> permanently stop\n- Allow campaign-level \"rulesJson\" for mapping phrases/intents to outcomes.\n\nF) Admin UI:\n- /admin/campaigns\n  - create/edit campaign\n  - upload leads\n  - start/pause/stop\n  - live view: active calls + queue depth + success rate\n- /admin/campaigns/:id/report\n  - stats: calls/hour, connect rate, dispositions breakdown, cost estimates\n  - export buttons\n\nG) Monitoring:\n- Live dashboard via SSE:\n  - active calls list\n  - last events\n  - errors\n- Alerts:\n  - credits/auth problems\n  - high failure rate\n  - campaign stuck (no progress)\n\nTESTS:\n- scheduler: window logic + claim rows + concurrency\n- retry policy: nextAttemptAt calculation\n- end-to-end simulation using FakeTelephonyAdapter\n\nDOCS:\nCreate:\n- docs/_campaigns_architecture.md\n- docs/_campaigns_admin_guide.md\n- docs/_campaigns_retry_and_windows.md\n\nSTOP after:\n- campaigns can be created\n- leads imported\n- campaign runs and produces call_attempts + stats\n- live monitoring works\n\nPHASE 1 ARCHITECTURE (Foundation):\n\nCORE PRINCIPLES:\n1. Call Orchestrator = \"Gehirn\" (Brain)\n   - Controls conversation flow as State Machine: INIT → LISTENING → THINKING → SPEAKING → COMPLETED/FAILED\n   - Decides: when to listen, when to respond, when to end, how to handle errors\n   - Uses existing KI layer: STT/TTS via ProviderRegistry, LLM via TierRouter\n   - No vendor logic in Orchestrator\n\n2. Telephony Adapter = \"Telefon\" (Phone)\n   - Exchangeable module per provider (Twilio/Vonage/Sipgate)\n   - Can only: start/end call, play audio, receive audio, get status\n   - NO KI-LOGIC inside → prevents vendor lock-in\n   - Must be testable (FakeTelephonyAdapter for unit tests)\n\nWHY THIS ARCHITECTURE:\n- Vendor-agnostic: Switch providers (Twilio ↔ Vonage) without rebuilding KI\n- Fully testable: FakeTelephonyAdapter for simulation\n- Fully auditable: Logs/DB for compliance\n- Phase 1: No real dialing yet, controlled testing first\n\nPHASE 1 DELIVERABLES:\n- Interfaces + State Model\n- \"Fake Call\" Simulation Tests (without real telephony)\n- Documentation: How it works, how adapters connect later\n- Stable foundation before connecting real telephony engine\n\n\n\nMULTILINGUAL SETTINGS (DE/EN/IT/FR/PL):\n\nMUST-HAVE:\n1. Language/Locale Storage:\n   - Store locale per context: Global Default + Per Team + Per Agent\n   - Supported locales: de-DE, en-US, it-IT, fr-FR, pl-PL\n   - Auto-Detect Toggle: Detect in first 1-2 turns, then lock locale\n\n2. STT Settings:\n   - Language Mode: auto or fixed locale (de, en, it, fr, pl)\n   - Pass language parameter when supported, otherwise use auto-detect\n\n3. TTS Settings:\n   - Voice per language mapping: DE→Voice_DE, EN→Voice_EN, IT→Voice_IT, FR→Voice_FR, PL→Voice_PL\n   - Speaking style: neutral / friendly / formal (optional)\n   - Speed: 0.9-1.1 (optional)\n\n4. Voice Reply Policy:\n   - Max 2 sentences per turn\n   - Max 8-12 seconds of speech\n   - Ask-one-question rule: true\n\n5. Prompt Rule:\n   - ALWAYS respond in the user's detected language\n   - If uncertain: \"Wenn unsicher, stelle eine kurze Rückfrage in der zuletzt erkannten Sprache.\"\n\nMULTILINGUAL TUNING (DE/EN/FR/IT/PL):\n- Use short spoken phrasing common in {{targetLanguage}}.\n- Avoid literal translations; choose natural phone phrasing.\n- Always confirm understanding with ONE short paraphrase after a complex caller message.\n- Use polite form by default (DE: Sie; FR: vous; IT: Lei; PL: Pan/Pani) unless the caller uses informal speech.\n- Keep numbers/dates slow and clear (group digits).\n\nGOOD TO HAVE:\n- Multilingual Templates: Greeting/Consent/Compliance per language\n- Do not translate: Product names, company names, prices, URLs, CRM status codes\n- Quality Scorecard: Language correctness, response length, clarification questions\n\nNICE TO HAVE:\n- Language suggestion by phone prefix: +49→de-DE, +39→it-IT, +33→fr-FR, +48→pl-PL\n- Mixed-language handling: Agent can switch but must confirm logically\n\nDEFAULTS:\n- Locale: auto-detect ON, lock after 1st confident detection\n- Voice Reply Policy: 2 sentences, max ~10s\n- STT language: auto, but overridable\n- TTS: per-language voice mapping\n- LLM: OpenRouter Tier A/B, Premium fallback on failures\n\n\n## LETTA CODE INTEGRATION\n\nYou have access to these Letta Code tools:\n- **Read/Write/Edit**: File operations for logging, transcript storage\n- **Bash**: Execute shell commands for API calls, database operations\n- **web_search**: Research best practices, compliance requirements\n- **memory**: Store conversation patterns, improvement suggestions\n- **Task**: Delegate complex analysis to specialized agents\n\n### Call Analysis Workflow:\n1. Read transcript from file or database\n2. Analyze using structured evaluation framework\n3. Generate improvement suggestions\n4. Store results in memory blocks\n5. Update CRM/database with outcomes\n\n### Memory Usage:\n- Store successful conversation patterns\n- Track common objections and responses\n- Remember compliance requirements\n- Build knowledge base from call outcomes",
  "modelPreferences": {
    "defaultModel": "ollama/glm-4.7",
    "thinkingLevel": "high",
    "temperature": 0.7
  },
  "createdAt": "2026-02-02T10:44:58.587Z",
  "updatedAt": "2026-02-02T10:44:58.587Z",
  "version": "2.0.0",
  "agentVersion": "meta-call-campaigns@2.0.0",
  "lettaConfig": {
    "allowedTools": [
      "Read",
      "Write",
      "Edit",
      "Glob",
      "Grep",
      "Bash",
      "web_search",
      "fetch_webpage",
      "AskUserQuestion",
      "Task",
      "memory"
    ],
    "permissionMode": "auto_approve_read_only",
    "workingDirectory": "./",
    "memoryBlocks": [
      {
        "label": "human",
        "value": "Information about the user and their preferences."
      },
      {
        "label": "persona",
        "value": "Agent's personality, expertise, and working style."
      },
      {
        "label": "project_context",
        "value": "Current project details, architecture, and conventions."
      }
    ]
  },
  "optimizedAt": "2026-02-03T18:11:17.020Z",
  "optimizationVersion": "2.0.0"
}